#version: "3.9"
###############################################################################
# MATRIX-TEXTVOICEVIDEO — Docker Compose Stack
# A Self-Hosted Discord-Like Alternative
# Text · Voice (Coturn) · Video (Jitsi) · 10-50 concurrent users
#
# ─────────────────────────────────────────────────────────────────────────────
# QUICK START
# ─────────────────────────────────────────────────────────────────────────────
#   1. Copy .env.example to .env and fill in all values
#   2. Run scripts/certbot-init.sh to obtain your TLS certificate
#   3. docker compose up -d
#
# ─────────────────────────────────────────────────────────────────────────────
# BRIDGE NETWORK (matrix-net 172.42.0.0/24) — static IPs
# ─────────────────────────────────────────────────────────────────────────────
#   valkey          172.42.0.7
#   postgres        172.42.0.2
#   synapse         172.42.0.3
#   element-web     172.42.0.4
#   nginx           172.42.0.10
#   jitsi-prosody   172.42.0.20
#   jitsi-jicofo    172.42.0.21
#   jitsi-web       172.42.0.22
#
# ─────────────────────────────────────────────────────────────────────────────
# HOST NETWORK containers (require host networking for WebRTC/TURN)
# ─────────────────────────────────────────────────────────────────────────────
#   coturn          host (ports 3478/5349)
#   jitsi-jvb       host (port UDP 10000)
#
# ─────────────────────────────────────────────────────────────────────────────
# EXPOSED PORTS — configure your router to forward these:
# ─────────────────────────────────────────────────────────────────────────────
#   WAN :80    → Unraid IP :60080   (nginx HTTP / Let's Encrypt ACME)
#   WAN :443   → Unraid IP :60443   (nginx HTTPS)
#   WAN :3478  → Unraid IP :3478    (coturn TURN/STUN)
#   WAN :5349  → Unraid IP :5349    (coturn TURNS over TLS)
#   WAN :10000 → Unraid IP :10000   (jitsi-jvb WebRTC media, UDP)
#
#   WHY 60080/60443 and not 80/443?
#   Unraid's own web GUI occupies host ports 80 and 443, so nginx must
#   use alternate host ports.  Your router NAT bridges the gap externally.
#
# ─────────────────────────────────────────────────────────────────────────────
# .env / env_file NOTE
# ─────────────────────────────────────────────────────────────────────────────
#   Unraid Compose Manager automatically loads the .env file sitting next to
#   this docker-compose.yml — you do NOT need env_file lines on Unraid.
#
#   On all other systems (Debian, Ubuntu, Proxmox, etc.) uncomment every
#     # env_file: .env
#   line below so that variables are injected into each container correctly.
#
# ─────────────────────────────────────────────────────────────────────────────
# TLS CERTIFICATES
# ─────────────────────────────────────────────────────────────────────────────
#   Initial issuance : run scripts/certbot-init.sh  (interactive, one-time)
#   Renewal          : run scripts/certbot-renew.sh (monthly cron recommended)
#
#   Unraid User Scripts cron example (monthly at 03:00 on the 1st):
#     0 3 1 * *  /mnt/user/appdata/matrix-textvoicevideo/scripts/certbot-renew.sh
#
#   The certbot service at the bottom of this file uses profile "tls" so it
#   does NOT start automatically with `docker compose up -d`.
#   To run a one-off renewal via compose:
#     docker compose --profile tls up certbot
#
###############################################################################

networks:
  matrix-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.42.0.0/24

services:

  ###########################################################################
  # VALKEY — Redis-compatible cache used by Synapse for coordination
  ###########################################################################
  valkey:
    image: valkey/valkey:latest
    container_name: matrix-valkey
    # env_file: .env          # ← Uncomment on non-Unraid systems
    command: ["valkey-server", "--appendonly", "yes"]
    volumes:
      - ${DATA_DIR}/valkey:/data
    networks:
      matrix-net:
        ipv4_address: 172.42.0.7
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/SnuK87/unraid-templates/refs/heads/main/icons/valkey-logo.png"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # POSTGRES — Database backend for Synapse
  #
  # IMPORTANT: Synapse requires the database to use C locale.
  # POSTGRES_INITDB_ARGS is set in .env — do not change the locale settings.
  ###########################################################################
  postgres:
    image: postgres:16-alpine
    container_name: matrix-postgres
    # env_file: .env          # ← Uncomment on non-Unraid systems
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_INITDB_ARGS: ${POSTGRES_INITDB_ARGS}
    volumes:
      - ${DATA_DIR}/postgres:/var/lib/postgresql/data
    networks:
      matrix-net:
        ipv4_address: 172.42.0.2
    restart: unless-stopped
    shm_size: 256mb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      net.unraid.docker.icon: "https://cdn.jsdelivr.net/gh/selfhst/icons/png/postgresql.png"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # SYNAPSE — Matrix Homeserver
  #
  # Config lives in DATA_DIR/synapse/appdata/homeserver.yaml
  # Generate an initial config with:
  #   docker run --rm -v /your/data/synapse:/data \
  #     matrixdotorg/synapse:latest generate
  #
  # TLS certs are mounted read-only — Synapse uses them for federation.
  ###########################################################################
  synapse:
    image: matrixdotorg/synapse:latest
    container_name: matrix-synapse
    # env_file: .env          # ← Uncomment on non-Unraid systems
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SERVER_NAME}
      SYNAPSE_REPORT_STATS: "no"
    volumes:
      - ${DATA_DIR}/synapse/appdata:/data
      - ${DATA_DIR}/synapse/media_store:/data/media_store
      - ${DATA_DIR}/nginx/certs/live/${SERVER_NAME}:/certs:ro
    networks:
      matrix-net:
        ipv4_address: 172.42.0.3
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fSs", "http://localhost:8008/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      net.unraid.docker.icon: "https://cdn.jsdelivr.net/gh/selfhst/icons/png/matrix.png"
      net.unraid.docker.webui: "http://[IP]:[PORT:60080]"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # ELEMENT WEB — Matrix chat UI (the "Discord" front-end)
  #
  # Config: DATA_DIR/element-web/config/config.json
  # Minimal config.json example:
  #   {
  #     "default_server_config": {
  #       "m.homeserver": {
  #         "base_url": "https://YOUR_MATRIX_DOMAIN",
  #         "server_name": "YOUR_SERVER_NAME"
  #       }
  #     }
  #   }
  ###########################################################################
  element-web:
    image: vectorim/element-web:latest
    container_name: matrix-element-web
    # env_file: .env          # ← Uncomment on non-Unraid systems
    volumes:
      - ${DATA_DIR}/element-web/config/config.json:/app/config.json:ro
    networks:
      matrix-net:
        ipv4_address: 172.42.0.4
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://cdn.jsdelivr.net/gh/selfhst/icons/png/element.png"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # COTURN — TURN/STUN server for NAT traversal (voice call media relay)
  #
  # Uses host networking so it can bind directly to the real network
  # interface — required for TURN to work correctly.
  #
  # Config: DATA_DIR/coturn/config/turnserver.conf
  # Key settings to verify in turnserver.conf:
  #   listening-port=3478
  #   tls-listening-port=5349
  #   cert=/certs/fullchain.pem
  #   pkey=/certs/privkey.pem
  #   realm=YOUR_DOMAIN
  #   use-auth-secret
  #   static-auth-secret=YOUR_TURN_SECRET   ← match TURN_SECRET in .env
  ###########################################################################
  coturn:
    image: coturn/coturn:latest
    container_name: matrix-coturn
    # env_file: .env          # ← Uncomment on non-Unraid systems
    network_mode: host
    volumes:
      - ${DATA_DIR}/coturn/config/turnserver.conf:/etc/turnserver.conf:ro
      - ${DATA_DIR}/nginx/certs/live/${SERVER_NAME}:/certs:ro
    command: ["turnserver", "-c", "/etc/turnserver.conf"]
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/xthursdayx/docker-templates/master/xthursdayx/images/webrtc-icon.png"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # NGINX — Reverse Proxy + TLS Termination
  #
  # Handles routing for: Matrix API, Element Web, Jitsi Web, .well-known
  #
  # HOST PORTS (Unraid-specific — see header for why):
  #   60080 → container :80   (HTTP, used for ACME challenge redirect)
  #   60443 → container :443  (HTTPS, all user traffic)
  #
  # Config: DATA_DIR/nginx/nginx.conf
  # Certs:  DATA_DIR/nginx/certs/live/YOUR_DOMAIN/{fullchain,privkey}.pem
  #
  # NOTE: During certificate renewal, certbot-renew.sh will stop this
  # container briefly so it can bind port 60080 for the ACME challenge.
  ###########################################################################
  nginx:
    image: nginx:alpine
    container_name: matrix-nginx
    # env_file: .env          # ← Uncomment on non-Unraid systems
    volumes:
      - ${DATA_DIR}/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${DATA_DIR}/nginx/html:/var/www/html:ro
      - ${DATA_DIR}/nginx/certs:/etc/nginx/certs:ro
    networks:
      matrix-net:
        ipv4_address: 172.42.0.10
    ports:
      - "60080:80"    # WAN:80 → router NAT → Unraid:60080 → nginx:80
      - "60443:443"   # WAN:443 → router NAT → Unraid:60443 → nginx:443
    depends_on:
      - synapse
      - element-web
      - jitsi-web
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://nginxproxymanager.com/icon.png"
      net.unraid.docker.webui: "https://[IP]:[PORT:60443]"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # JITSI — Self-Hosted Video Conferencing (meet.YOUR_DOMAIN)
  #
  # Four components:
  #   prosody  — XMPP signaling server
  #   jicofo   — conference focus / room manager
  #   web      — Jitsi Meet browser UI
  #   jvb      — Video Bridge (actual WebRTC media, host networking)
  ###########################################################################

  # ── Prosody (XMPP) ────────────────────────────────────────────────────────
  jitsi-prosody:
    image: jitsi/prosody:stable
    container_name: jitsi-prosody
    # env_file: .env          # ← Uncomment on non-Unraid systems
    networks:
      matrix-net:
        ipv4_address: 172.42.0.20
    environment:
      TZ: ${TZ}
      XMPP_DOMAIN: ${JITSI_DOMAIN}
      XMPP_AUTH_DOMAIN: ${JITSI_AUTH_DOMAIN}
      XMPP_MUC_DOMAIN: ${JITSI_MUC_DOMAIN}
      XMPP_INTERNAL_MUC_DOMAIN: ${JITSI_INTERNAL_MUC_DOMAIN}
      JICOFO_AUTH_PASSWORD: ${JICOFO_AUTH_PASSWORD}
      JVB_AUTH_PASSWORD: ${JVB_AUTH_PASSWORD}
      ENABLE_AUTH: "0"    # Set to "1" to require login for meetings
      ENABLE_GUESTS: "1"  # Set to "0" to disallow anonymous guests
    volumes:
      - ${DATA_DIR}/jitsi/prosody:/config
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-docker-templates/refs/heads/main/images/jitsi.png"
      net.unraid.docker.managed: "composeman"

  # ── Jicofo (conference focus) ──────────────────────────────────────────────
  jitsi-jicofo:
    image: jitsi/jicofo:stable
    container_name: jitsi-jicofo
    # env_file: .env          # ← Uncomment on non-Unraid systems
    depends_on:
      - jitsi-prosody
    networks:
      matrix-net:
        ipv4_address: 172.42.0.21
    environment:
      TZ: ${TZ}
      XMPP_DOMAIN: ${JITSI_DOMAIN}
      XMPP_AUTH_DOMAIN: ${JITSI_AUTH_DOMAIN}
      XMPP_INTERNAL_MUC_DOMAIN: ${JITSI_INTERNAL_MUC_DOMAIN}
      XMPP_SERVER: jitsi-prosody
      JICOFO_AUTH_PASSWORD: ${JICOFO_AUTH_PASSWORD}
    volumes:
      - ${DATA_DIR}/jitsi/jicofo:/config
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-docker-templates/refs/heads/main/images/jitsi.png"
      net.unraid.docker.managed: "composeman"

  # ── Jitsi Web (browser UI) ─────────────────────────────────────────────────
  jitsi-web:
    image: jitsi/web:stable
    container_name: jitsi-web
    # env_file: .env          # ← Uncomment on non-Unraid systems
    depends_on:
      - jitsi-prosody
      - jitsi-jicofo
    networks:
      matrix-net:
        ipv4_address: 172.42.0.22
    environment:
      TZ: ${TZ}
      PUBLIC_URL: ${JITSI_PUBLIC_URL}
      XMPP_DOMAIN: ${JITSI_DOMAIN}
      XMPP_AUTH_DOMAIN: ${JITSI_AUTH_DOMAIN}
      XMPP_BOSH_URL_BASE: "http://jitsi-prosody:5280"
      XMPP_SERVER: jitsi-prosody
    volumes:
      - ${DATA_DIR}/jitsi/web:/config
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-docker-templates/refs/heads/main/images/jitsi.png"
      net.unraid.docker.webui: "https://[IP]:[PORT:60443]"
      net.unraid.docker.managed: "composeman"

  # ── JVB — Jitsi Video Bridge (WebRTC media relay) ─────────────────────────
  # Uses host networking — JVB must bind directly to the real network
  # interface so WebRTC peers can reach it on UDP :10000.
  # JVB_ADVERTISE_IPS must be set to your PUBLIC WAN IP in .env.
  jitsi-jvb:
    image: jitsi/jvb:stable
    container_name: jitsi-jvb
    # env_file: .env          # ← Uncomment on non-Unraid systems
    network_mode: host
    depends_on:
      - jitsi-prosody
    environment:
      TZ: ${TZ}
      XMPP_DOMAIN: ${JITSI_DOMAIN}
      XMPP_AUTH_DOMAIN: ${JITSI_AUTH_DOMAIN}
      XMPP_INTERNAL_MUC_DOMAIN: ${JITSI_INTERNAL_MUC_DOMAIN}
      XMPP_SERVER: 172.42.0.20  # Static IP — JVB is host-networked, cannot use container name
      JVB_AUTH_PASSWORD: ${JVB_AUTH_PASSWORD}
      JVB_PORT: ${JVB_PORT}
      JVB_ADVERTISE_IPS: ${JVB_ADVERTISE_IPS}  # Set to your public WAN IP
    volumes:
      - ${DATA_DIR}/jitsi/jvb:/config
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-docker-templates/refs/heads/main/images/jitsi.png"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # CERTBOT — TLS Certificate Renewal
  #
  # profiles: ["tls"] — this service does NOT start with `docker compose up -d`
  # It only runs when explicitly triggered:
  #   docker compose --profile tls up certbot
  #
  # ── UNRAID USERS ──────────────────────────────────────────────────────────
  # The recommended renewal method on Unraid is a monthly cron via the
  # "User Scripts" plugin, which runs scripts/certbot-renew.sh.
  # That script safely stops nginx (freeing port 60080), runs certbot,
  # then restarts nginx automatically.
  #
  # Cron schedule (User Scripts / root crontab):
  #   0 3 1 * *  /mnt/user/appdata/matrix-textvoicevideo/scripts/certbot-renew.sh
  #
  # ── NON-UNRAID USERS (standard 80/443) ───────────────────────────────────
  # If nginx is on standard ports 80/443, you can use the webroot method
  # instead (nginx stays running). Replace the entrypoint below with:
  #   entrypoint: /bin/sh -c 'trap exit TERM; while :; do certbot renew
  #     --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done'
  # And remove the ports block — no port binding needed for webroot.
  #
  # ── HOW THE UNRAID STANDALONE METHOD WORKS ───────────────────────────────
  # 1. This container binds host :60080 (→ container :80)
  # 2. Your router NAT forwards WAN:80 → Unraid:60080
  # 3. Let's Encrypt reaches certbot via that path for the HTTP-01 challenge
  # 4. nginx MUST be stopped first (also uses host :60080)
  #    → certbot-renew.sh handles stop/start automatically
  ###########################################################################
  certbot:
    image: certbot/certbot:latest
    container_name: matrix-certbot
    profiles: ["tls"]
    volumes:
      - ${DATA_DIR}/nginx/certs:/etc/letsencrypt
      - ${DATA_DIR}/nginx/html:/var/www/certbot
    ports:
      - "60080:80"    # Must match nginx HTTP port — nginx must be stopped first!
    entrypoint: >
      /bin/sh -c '
        trap exit TERM;
        while :; do
          certbot renew
            --standalone
            --http-01-port 80
            --preferred-challenges http
            --quiet;
          sleep 12h & wait $${!};
        done
      '
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://cdn.jsdelivr.net/gh/selfhst/icons/png/lets-encrypt.png"
      net.unraid.docker.managed: "composeman"
