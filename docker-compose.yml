#version: "3.9"
###############################################################################
# MATRIX-TEXTVOICEVIDEO — Docker Compose Stack
# A Self-Hosted Discord-Like Alternative
# Text · Voice (Coturn) · Video (Jitsi) · 10-50 concurrent users
#
# ─────────────────────────────────────────────────────────────────────────────
# BRIDGE NETWORK (matrix-net 172.42.0.0/24) — static IPs
# ─────────────────────────────────────────────────────────────────────────────
#   valkey          172.42.0.7
#   postgres        172.42.0.2
#   synapse         172.42.0.3
#   element-web     172.42.0.4
#   nginx           172.42.0.10
#   jitsi-prosody   172.42.0.20
#   jitsi-jicofo    172.42.0.21
#   jitsi-web       172.42.0.22
#
# ─────────────────────────────────────────────────────────────────────────────
# HOST NETWORK containers (require host networking for WebRTC/TURN)
# ─────────────────────────────────────────────────────────────────────────────
#   coturn          host (3478/5349)
#   jitsi-jvb       host (UDP 10000)
#
# ─────────────────────────────────────────────────────────────────────────────
# EXPOSED PORTS (map your router: WAN → Unraid)
# ─────────────────────────────────────────────────────────────────────────────
#   WAN 443   → Unraid:60443  (nginx HTTPS)
#   WAN 80    → Unraid:60080  (nginx HTTP / ACME)
#   WAN 3478  → Unraid:3478   (coturn TURN/STUN)
#   WAN 5349  → Unraid:5349   (coturn TURNS/TLS)
#   WAN 10000 UDP → Unraid:10000 (jitsi-jvb WebRTC media)
#
# ─────────────────────────────────────────────────────────────────────────────
# env_file NOTE (Unraid Compose Manager):
# ─────────────────────────────────────────────────────────────────────────────
# Unraid's Compose Manager automatically loads the .env file from the same
# directory as docker-compose.yml — you do NOT need env_file lines.
#
# For all OTHER distros (Debian, Ubuntu, etc.) uncomment the
#   # env_file: .env
# line inside each service block below so variables resolve correctly.
###############################################################################

networks:
  matrix-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.42.0.0/24

services:

  ###########################################################################
  # VALKEY — Redis-compatible cache (Synapse coordination)
  ###########################################################################
  valkey:
    image: valkey/valkey:latest
    container_name: matrix-valkey
    # env_file: .env          # ← Uncomment on non-Unraid systems
    command: ["valkey-server", "--appendonly", "yes"]
    volumes:
      - ${DATA_DIR}/valkey:/data
    networks:
      matrix-net:
        ipv4_address: 172.42.0.7
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/SnuK87/unraid-templates/refs/heads/main/icons/valkey-logo.png"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # POSTGRES — Database (C locale required by Synapse)
  ###########################################################################
  postgres:
    image: postgres:16-alpine
    container_name: matrix-postgres
    # env_file: .env          # ← Uncomment on non-Unraid systems
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_INITDB_ARGS: ${POSTGRES_INITDB_ARGS}
    volumes:
      - ${DATA_DIR}/postgres:/var/lib/postgresql/data
    networks:
      matrix-net:
        ipv4_address: 172.42.0.2
    restart: unless-stopped
    shm_size: 256mb
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      net.unraid.docker.icon: "https://cdn.jsdelivr.net/gh/selfhst/icons/png/postgresql.png"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # SYNAPSE — Matrix Homeserver
  ###########################################################################
  synapse:
    image: matrixdotorg/synapse:latest
    container_name: matrix-synapse
    # env_file: .env          # ← Uncomment on non-Unraid systems
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
    environment:
      SYNAPSE_SERVER_NAME: ${SERVER_NAME}
      SYNAPSE_REPORT_STATS: "no"
    volumes:
      - ${DATA_DIR}/synapse/appdata:/data
      - ${DATA_DIR}/synapse/media_store:/data/media_store
      # TLS certs shared with nginx/coturn (read-only)
      - ${DATA_DIR}/nginx/certs/live/${SERVER_NAME}:/certs:ro
    networks:
      matrix-net:
        ipv4_address: 172.42.0.3
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fSs", "http://localhost:8008/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      net.unraid.docker.icon: "https://cdn.jsdelivr.net/gh/selfhst/icons/png/matrix.png"
      net.unraid.docker.webui: "http://[IP]:[PORT:60080]"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # ELEMENT WEB — Chat UI (like Discord)
  ###########################################################################
  element-web:
    image: vectorim/element-web:latest
    container_name: matrix-element-web
    # env_file: .env          # ← Uncomment on non-Unraid systems
    volumes:
      - ${DATA_DIR}/element-web/config/config.json:/app/config.json:ro
    networks:
      matrix-net:
        ipv4_address: 172.42.0.4
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://cdn.jsdelivr.net/gh/selfhst/icons/png/element.png"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # COTURN — TURN/STUN relay for NAT traversal (voice call fallback)
  # Uses host networking so it can bind to the real network interface
  ###########################################################################
  coturn:
    image: coturn/coturn:latest
    container_name: matrix-coturn
    # env_file: .env          # ← Uncomment on non-Unraid systems
    network_mode: host
    volumes:
      - ${DATA_DIR}/coturn/config/turnserver.conf:/etc/turnserver.conf:ro
      - ${DATA_DIR}/nginx/certs/live/${SERVER_NAME}:/certs:ro
    command: ["turnserver", "-c", "/etc/turnserver.conf"]
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/xthursdayx/docker-templates/master/xthursdayx/images/webrtc-icon.png"
      net.unraid.docker.managed: "composeman"

  ###########################################################################
  # NGINX — Reverse Proxy + TLS Termination
  # Handles: Matrix API, Element Web, Jitsi Web, .well-known
  ###########################################################################
  nginx:
    image: nginx:alpine
    container_name: matrix-nginx
    # env_file: .env          # ← Uncomment on non-Unraid systems
    volumes:
      - ${DATA_DIR}/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${DATA_DIR}/nginx/html:/var/www/html:ro
      - ${DATA_DIR}/nginx/certs:/etc/nginx/certs:ro
    networks:
      matrix-net:
        ipv4_address: 172.42.0.10
    ports:
      - "60080:80"
      - "60443:443"
    depends_on:
      - synapse
      - element-web
      - jitsi-web
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://nginxproxymanager.com/icon.png"
      net.unraid.docker.webui: "https://[IP]:[PORT:60443]"
      net.unraid.docker.managed: "composeman"

###############################################################################
# JITSI — Self-Hosted Video (meet.domain_name)
# Prosody = XMPP server (Jitsi signaling)
# Jicofo  = conference focus component
# Web     = Jitsi Meet UI
# JVB     = Video Bridge (WebRTC media) — host networking required
###############################################################################

  jitsi-prosody:
    image: jitsi/prosody:stable
    container_name: jitsi-prosody
    # env_file: .env          # ← Uncomment on non-Unraid systems
    networks:
      matrix-net:
        ipv4_address: 172.42.0.20
    environment:
      TZ: ${TZ}
      XMPP_DOMAIN: ${JITSI_DOMAIN}
      XMPP_AUTH_DOMAIN: ${JITSI_AUTH_DOMAIN}
      XMPP_MUC_DOMAIN: ${JITSI_MUC_DOMAIN}
      XMPP_INTERNAL_MUC_DOMAIN: ${JITSI_INTERNAL_MUC_DOMAIN}
      JICOFO_AUTH_PASSWORD: ${JICOFO_AUTH_PASSWORD}
      JVB_AUTH_PASSWORD: ${JVB_AUTH_PASSWORD}
      ENABLE_AUTH: "0"
      ENABLE_GUESTS: "1"
    volumes:
      - ${DATA_DIR}/jitsi/prosody:/config
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-docker-templates/refs/heads/main/images/jitsi.png"
      net.unraid.docker.managed: "composeman"

  jitsi-jicofo:
    image: jitsi/jicofo:stable
    container_name: jitsi-jicofo
    # env_file: .env          # ← Uncomment on non-Unraid systems
    depends_on:
      - jitsi-prosody
    networks:
      matrix-net:
        ipv4_address: 172.42.0.21
    environment:
      TZ: ${TZ}
      XMPP_DOMAIN: ${JITSI_DOMAIN}
      XMPP_AUTH_DOMAIN: ${JITSI_AUTH_DOMAIN}
      XMPP_INTERNAL_MUC_DOMAIN: ${JITSI_INTERNAL_MUC_DOMAIN}
      XMPP_SERVER: jitsi-prosody
      JICOFO_AUTH_PASSWORD: ${JICOFO_AUTH_PASSWORD}
    volumes:
      - ${DATA_DIR}/jitsi/jicofo:/config
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-docker-templates/refs/heads/main/images/jitsi.png"
      net.unraid.docker.managed: "composeman"

  jitsi-web:
    image: jitsi/web:stable
    container_name: jitsi-web
    # env_file: .env          # ← Uncomment on non-Unraid systems
    depends_on:
      - jitsi-prosody
      - jitsi-jicofo
    networks:
      matrix-net:
        ipv4_address: 172.42.0.22
    environment:
      TZ: ${TZ}
      PUBLIC_URL: ${JITSI_PUBLIC_URL}
      XMPP_DOMAIN: ${JITSI_DOMAIN}
      XMPP_AUTH_DOMAIN: ${JITSI_AUTH_DOMAIN}
      XMPP_BOSH_URL_BASE: "http://jitsi-prosody:5280"
      XMPP_SERVER: jitsi-prosody
    volumes:
      - ${DATA_DIR}/jitsi/web:/config
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-docker-templates/refs/heads/main/images/jitsi.png"
      net.unraid.docker.webui: "https://[IP]:[PORT:60443]"
      net.unraid.docker.managed: "composeman"

  jitsi-jvb:
    image: jitsi/jvb:stable
    container_name: jitsi-jvb
    # env_file: .env          # ← Uncomment on non-Unraid systems
    # host networking required — JVB must bind to the real interface for WebRTC
    network_mode: host
    depends_on:
      - jitsi-prosody
    environment:
      TZ: ${TZ}
      XMPP_DOMAIN: ${JITSI_DOMAIN}
      XMPP_AUTH_DOMAIN: ${JITSI_AUTH_DOMAIN}
      XMPP_INTERNAL_MUC_DOMAIN: ${JITSI_INTERNAL_MUC_DOMAIN}
      # Uses bridge IP — JVB is host-networked so must address prosody by IP
      XMPP_SERVER: 172.42.0.20
      JVB_AUTH_PASSWORD: ${JVB_AUTH_PASSWORD}
      JVB_PORT: ${JVB_PORT}
      JVB_ADVERTISE_IPS: ${JVB_ADVERTISE_IPS}
    volumes:
      - ${DATA_DIR}/jitsi/jvb:/config
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://raw.githubusercontent.com/bmartino1/unraid-docker-templates/refs/heads/main/images/jitsi.png"
      net.unraid.docker.managed: "composeman"


  ###########################################################################
  # CERTBOT — Auto TLS renewal (renews every 12h)
  # profiles: ["tls"] means it only starts when you run:
  #   docker compose --profile tls up -d
  # OR remove the profiles line to always include it in the stack.
  ###########################################################################

  # =============================================================================
#  docker-compose certbot service — Unraid 60080/60443 topology
#
#  IMPORTANT: The compose-based auto-renew certbot service is DISABLED by
#  default on Unraid because it needs to stop nginx (to free port 60080)
#  before each renewal attempt, which the "while :; sleep 12h" loop below
#  cannot safely do on its own.
#
#  RECOMMENDED APPROACH on Unraid:
#    Use the Unraid "User Scripts" plugin to run certbot-renew.sh monthly.
#    Example schedule: 0 3 1 * *  (3 AM on the 1st of every month)
#    Script: /mnt/user/appdata/matrix-textvoicevideo/scripts/certbot-renew.sh
#
#  The service below is provided for non-Unraid deployments or environments
#  where nginx is on standard ports 80/443 (no stop/start needed).
#  On those systems: uncomment and remove the profiles line.
# =============================================================================

  certbot:
    image: certbot/certbot:latest
    container_name: matrix-certbot
    profiles: ["tls"]          # Remove this line on standard 80/443 systems
    volumes:
      - ${DATA_DIR}/nginx/certs:/etc/letsencrypt
      - ${DATA_DIR}/nginx/html:/var/www/certbot
    # ── Standard (non-Unraid) renewal loop ───────────────────────────────────
    # Uses webroot method — nginx must be running and serving /.well-known/
    # entrypoint: /bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done'

    # ── Unraid workaround: standalone renewal via 60080 ──────────────────────
    # This stops nginx, binds :60080, renews, then exits.
    # On Unraid, trigger this manually or via User Scripts rather than
    # relying on the loop, since it cannot restart nginx from inside compose.
    entrypoint: >
      /bin/sh -c '
        trap exit TERM;
        while :; do
          certbot renew
            --standalone
            --http-01-port 80
            --preferred-challenges http
            --quiet;
          sleep 12h & wait $${!};
        done
      '
    # Port mapping: host 60080 → container 80
    # This lets Let's Encrypt reach the container via your router NAT (WAN:80 → Unraid:60080)
    ports:
      - "60080:80"
    restart: unless-stopped
    labels:
      net.unraid.docker.icon: "https://cdn.jsdelivr.net/gh/selfhst/icons/png/lets-encrypt.png"
      net.unraid.docker.managed: "composeman"

#TLS

# =============================================================================
#  NOTE: If you use the compose certbot service on Unraid, you MUST ensure
#  nginx is stopped before this container tries to renew (so it can bind
#  port 60080).  The safest approach remains the User Scripts cron method
#  using certbot-renew.sh which handles the stop/start automatically.
# =============================================================================
