# Matrix-TextVoiceVideo

**A self-hosted, Discord-like alternative for text, voice, and video chat.**
Built on [Matrix](https://matrix.org) + [Element Web](https://element.io) + [Jitsi](https://jitsi.org) + [Coturn](https://github.com/coturn/coturn). Optimised for [Unraid](https://unraid.net) but runs on any Docker host.

Supports **10-50 concurrent users** in voice/video rooms.

---

## Stack

| Service | Purpose | Network |
|---|---|---|
| **Synapse** | Matrix homeserver | 172.42.0.3 |
| **PostgreSQL** | Database (C locale) | 172.42.0.2 |
| **Valkey** | Redis-compatible cache | 172.42.0.7 |
| **Element Web** | Chat UI (like Discord) | 172.42.0.4 |
| **Jitsi Meet** | Video conference UI | 172.42.0.22 |
| **Jitsi Prosody** | XMPP signaling | 172.42.0.20 |
| **Jitsi Jicofo** | Conference focus | 172.42.0.21 |
| **Jitsi JVB** | WebRTC media bridge | host network |
| **Coturn** | TURN/STUN relay (NAT) | host network |
| **Nginx** | Reverse proxy + TLS | 172.42.0.10 |
| **Certbot** | Auto TLS renewal | — |

---

## Quick Start

```bash
# 1. Clone
git clone https://github.com/bmartino1/matrix-textvoicevideo.git /mnt/user/appdata/matrix-textvoicevideo
chmod 777 -R /mnt/user/appdata/matrix-textvoicevideo
cd /mnt/user/appdata/matrix-textvoicevideo

# 2. Run setup (auto-detects IPs, generates all secrets, builds configs)
sudo bash setup.sh --domain chat.yourdomain.com --reset
#Answer "YES" all caps no quotes...
#cat .env to verify enverioment bare min
```

Here is where Unraid user Will now add the Compose to the WebUI to enable necessary edits, icons and docker controls...
<img width="421" height="385" alt="image" src="https://github.com/user-attachments/assets/2b58492a-03eb-4d7a-833d-8ac0338aae8b" />

Edit Stack and open env adn compse files saving to lad web ui and hit update stack.

Other Distros:
```bash
# 3. Start the stack
docker compose up -d

# 4. Wait ~30s, then check health
./scripts/status.sh

# 5. Create your first admin user
./scripts/create-admin.sh admin

# 6. Create regular users
./scripts/create-user.sh alice
./scripts/create-user.sh bob
```

Open your browser at `https://chat.yourdomain.com`

Video calls via Jitsi at `https://meet.yourdomain.com`

---

## Setup Options

```
sudo bash setup.sh --domain <FQDN> [OPTIONS]

Required:
  --domain <FQDN>        Your fully qualified domain name (e.g. chat.example.com)

Optional:
  --external-ip <IP>     Public WAN IP (auto-detected via curl if omitted)
  --no-tls               Skip TLS / Let's Encrypt — HTTP only (LAN use)
  --admin-email <email>  Let's Encrypt registration email (default: admin@DOMAIN)
  --data-dir <path>      Data directory (default: /mnt/user/appdata/matrix-textvoicevideo/data)
  --tz <timezone>        Timezone (default: America/Chicago)
  --reset                WIPE ALL DATA and start fresh
  -h, --help             Show help
```

### Examples

```bash
# Standard production setup
sudo bash setup.sh --domain chat.example.com

# Specify public IP manually (if auto-detect fails)
sudo bash setup.sh --domain chat.example.com --external-ip 203.0.113.1

# LAN-only / no internet (no TLS)
sudo bash setup.sh --domain myserver.local --no-tls

# Custom data dir (non-Unraid)
sudo bash setup.sh --domain chat.example.com --data-dir /opt/matrix/data

# Complete wipe and reinstall
sudo bash setup.sh --domain chat.example.com --reset
```

---

## Admin Scripts

All scripts read settings from the `.env` file generated by `setup.sh`.

| Script | Usage | Purpose |
|---|---|---|
| `scripts/create-user.sh` | `./scripts/create-user.sh <name>` | Create a user |
| `scripts/create-admin.sh` | `./scripts/create-admin.sh <name>` | Create an admin user |
| `scripts/reset-password.sh` | `./scripts/reset-password.sh <name> <token>` | Reset password |
| `scripts/list-users.sh` | `./scripts/list-users.sh <token>` | List all users |
| `scripts/deactivate-user.sh` | `./scripts/deactivate-user.sh <name> <token>` | Disable a user |
| `scripts/backup.sh` | `./scripts/backup.sh [dest]` | Full backup |
| `scripts/status.sh` | `./scripts/status.sh` | Health check |
| `scripts/rotate-secrets.sh` | `./scripts/rotate-secrets.sh` | Rotate TURN/Jitsi secrets |

**Getting your admin access token:**
Log into Element Web → click your username → Settings → Help & About → Access Token

---

## Makefile Shortcuts

```bash
make up            # Start all services
make down          # Stop all services
make restart       # Restart stack
make logs          # Follow logs
make status        # Health check
make ps            # Container status
make create-user   # Interactive user creation
make create-admin  # Interactive admin creation
make backup        # Run backup
make list-users    # List users (prompts for token)
```

---

## Architecture

```
Internet
    │
    ├── 80/443 ──► Nginx (60080/60443)
    │                  ├── / ──────────────► Element Web  (172.42.0.4)
    │                  ├── /_matrix ─────►  Synapse       (172.42.0.3)
    │                  ├── /_synapse ────►  Synapse Admin (172.42.0.3)
    │                  ├── /.well-known ─►  nginx html dir
    │                  └── meet.DOMAIN ──►  Jitsi Web     (172.42.0.22)
    │
    ├── 3478/5349 ──► Coturn TURN/STUN (host network)
    │                  └── Voice relay for clients behind strict NAT
    │
    └── 10000 UDP ──► Jitsi JVB (host network)
                       └── WebRTC video/audio media bridge

Internal (matrix-net 172.42.0.0/24):
    Synapse ──► PostgreSQL (172.42.0.2)
    Synapse ──► Valkey     (172.42.0.7)
    Jitsi Jicofo ──► Prosody (172.42.0.20)
    Jitsi Web    ──► Prosody (172.42.0.20) [BOSH]
    Jitsi JVB    ──► Prosody (172.42.0.20) [host → bridge IP]
```

### Voice/Video Call Flow

1. User clicks **Video Call** in Element Web
2. Element Web launches a Jitsi widget pointing to `meet.DOMAIN`
3. Jitsi Meet connects via WebSocket/BOSH to Prosody (XMPP signaling)
4. Jicofo coordinates the conference room
5. JVB routes audio/video between participants (WebRTC)
6. Coturn provides TURN relay for users behind strict NAT

---

## Port Forwarding (Router/Firewall)

| External Port | Protocol | Forward To | Purpose |
|---|---|---|---|
| 80 | TCP | Unraid:60080 | HTTP + Let's Encrypt ACME |
| 443 | TCP | Unraid:60443 | HTTPS (Matrix + Jitsi UI) |
| 3478 | UDP+TCP | Unraid:3478 | TURN/STUN (voice relay) |
| 5349 | TCP | Unraid:5349 | TURNS over TLS |
| 49160-49250 | UDP | Unraid:49160-49250 | Coturn media ports |
| 10000 | UDP | Unraid:10000 | Jitsi JVB WebRTC media |

> **Unraid note:** Map WAN 80 → 60080 and WAN 443 → 60443 since ports below 1024 are typically managed by Unraid itself. Your router does the 80→60080 translation.

---

## DNS Records Required

```
chat.example.com    A    YOUR.PUBLIC.IP
meet.example.com    A    YOUR.PUBLIC.IP
```

> Both `chat.DOMAIN` and `meet.DOMAIN` need A records pointing to your public IP.
> The Let's Encrypt certificate covers both domains.

---

## Unraid Notes

- Stack runs as **root** — `chmod 777` is applied to data dirs for container compatibility
- Uses `composeman` labels for Unraid Docker Manager integration
- Deployed from `/mnt/user/appdata/matrix-textvoicevideo/` by default
- All containers have Unraid icon labels and WebUI links configured
- The `.env` file format is compatible with Unraid Compose Manager

---

## Security Defaults

- **Registration closed** — use `scripts/create-user.sh` to add users
- All secrets generated with `openssl rand` (cryptographically secure)
- `.env` is `chmod 600` — secrets not readable by other users
- Coturn blocks relay to all RFC 1918 private IP ranges (SSRF protection)
- No external Matrix key servers — fully self-contained
- Rate limiting on login, registration, and messaging
- Password policy: 10+ chars, upper + lower + digit required
- TLS 1.2/1.3 only, strong cipher suites, HSTS preload

---

## Troubleshooting

### Voice calls connect but no audio/video
- Verify `EXTERNAL_IP` in `.env` is your actual public IP (not LAN IP)
- Ensure UDP 10000 is port-forwarded to your Unraid server
- Check Coturn: UDP 3478 and TCP 5349 must be forwarded
- Run `./scripts/status.sh` to see which services are healthy

### "Cannot connect to homeserver"
- Check DNS: `nslookup chat.yourdomain.com` should return your public IP
- Check port forward: WAN 443 → Unraid:60443
- Check nginx logs: `docker compose logs matrix-nginx`

### Jitsi video room fails to start
- Check JVB is running: `docker compose ps jitsi-jvb`
- `JVB_ADVERTISE_IPS` in `.env` must be your public IP
- UDP 10000 must be forwarded

### Let's Encrypt certificate fails
- Port 80 must be publicly accessible (WAN 80 → Unraid:60080)
- DNS A records must already point to your IP (TTL propagated)
- Try: `docker compose logs matrix-certbot`

### Admin script "Could not reach Synapse"
- Ensure the stack is running: `docker compose ps`
- Try: `curl http://172.42.0.3:8008/_matrix/client/versions`

---

## Backup & Restore

```bash
# Create a backup (DB + configs + signing key + media)
./scripts/backup.sh

# Restore database
docker exec -i matrix-postgres pg_restore \
  -U synapse -d synapse < backups/TIMESTAMP/synapse.pgdump

# Restore configs
cp backups/TIMESTAMP/homeserver.yaml data/synapse/appdata/
cp backups/TIMESTAMP/dot.env .env && chmod 600 .env
docker compose restart
```

> **Critical:** The `*.signing.key` file is your server's cryptographic identity.
> Back it up regularly. If lost, federated users cannot verify your server.

---

## Updating

```bash
# Pull latest images
docker compose pull

# Restart with new images
docker compose down && docker compose up -d
```

> Run `./scripts/backup.sh` before updating.
