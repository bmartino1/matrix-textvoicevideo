##################################################################
# Synapse Homeserver Configuration
# matrix-textvoicevideo — Self-Hosted Discord Alternative
#
# This file is auto-generated by setup.sh.
# Placeholder values below are replaced by setup.sh using sed.
#
# Placeholder → .env variable mapping:
#   domain_name          → SERVER_NAME
#   https://domain_name  → PUBLIC_URL
#   CHANGEME_Postgres    → POSTGRES_PASSWORD
#   CHANGEME_Registration → SYNAPSE_REGISTRATION_SECRET
#   CHANGEME_Setup       → SYNAPSE_MACAROON_KEY
#   CHANGEME_Secret      → SYNAPSE_FORM_SECRET
#   CHANGEME_CoTurn      → TURN_SECRET
##################################################################

server_name: "domain_name"
public_baseurl: "https://domain_name/"
pid_file: /data/homeserver.pid
web_client_location: "https://domain_name/"
serve_server_wellknown: true

##################################################################
# LISTENERS
##################################################################
listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['0.0.0.0']
    resources:
      - names: [client, federation]
        compress: false

##################################################################
# DATABASE — PostgreSQL with C locale (required by Synapse)
##################################################################
database:
  name: psycopg2
  args:
    user: synapse
    password: "CHANGEME_Postgres"
    database: synapse
    host: matrix-postgres
    port: 5432
    cp_min: 5
    cp_max: 10

##################################################################
# REDIS / VALKEY — Required for worker coordination
##################################################################
redis:
  enabled: true
  host: matrix-valkey
  port: 6379

##################################################################
# LOGGING
##################################################################
log_config: "/data/domain_name.log.config"

##################################################################
# MEDIA
##################################################################
media_store_path: /data/media_store
max_upload_size: 100M
url_preview_enabled: true
url_preview_ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
  - '100.64.0.0/10'
  - '192.0.0.0/24'
  - '169.254.0.0/16'
  - '198.18.0.0/15'
  - 'fe80::/10'
  - 'fc00::/7'
  - '::1/128'

##################################################################
# SECRETS — all replaced by setup.sh
##################################################################
registration_shared_secret: "CHANGEME_Registration"
macaroon_secret_key: "CHANGEME_Setup"
form_secret: "CHANGEME_Secret"
signing_key_path: "/data/domain_name.signing.key"

##################################################################
# SECURITY
##################################################################
report_stats: false

# No external key servers — fully self-hosted
trusted_key_servers: []

# Registration is CLOSED — use scripts/create-user.sh to add users
enable_registration: false
enable_registration_without_verification: false

# Rate limiting
rc_message:
  per_second: 5
  burst_count: 20
rc_registration:
  per_second: 0.1
  burst_count: 3
rc_login:
  address:
    per_second: 0.5
    burst_count: 5
  account:
    per_second: 0.5
    burst_count: 5

# Session lifetime
session_lifetime: 24h
refresh_access_token_lifetime: 24h

# Password policy
password_config:
  enabled: true
  minimum_length: 10
  require_digit: true
  require_symbol: false
  require_lowercase: true
  require_uppercase: true

##################################################################
# TURN (Coturn) — Voice relay for NAT traversal
##################################################################
turn_uris:
  - "turn:domain_name:3478?transport=udp"
  - "turn:domain_name:3478?transport=tcp"
  - "turns:domain_name:5349?transport=tcp"
turn_shared_secret: "CHANGEME_CoTurn"
turn_user_lifetime: 1h
turn_allow_guests: false

##################################################################
# JITSI WIDGET — Video calling via meet.domain_name
##################################################################
# Element Web will use the Jitsi integration widget.
# The preferred_domain in element-web/config/config.json points
# to meet.domain_name — no additional Synapse config needed.

##################################################################
# FEDERATION — disabled for private self-hosted servers
##################################################################
allow_public_rooms_over_federation: false

##################################################################
# CACHING — tuned for 10-50 concurrent users
##################################################################
caches:
  global_factor: 1.0
  per_cache_factors:
    get_users_in_room: 2.0
